# Redis-主从复制

## 主从复制原理

### 建立连接阶段

1. 从服务器执行 slaveof masterip masterport，记录下 ip 与 port。
2. 从服务器每秒执行一次定时任务，尝试连接主服务器，如果建立成功
3. 从服务器建立一个处理器，负责处理后续的接收 rdb，接收命令等复制行为。
   此时，主服务器会将从服务器认为是自己的一个客户端，接收对方的命令，但不能主动发送命令。
4. 从节点发送 ping 命令，检测 socket 是否可用并检测主服务是否可以执行复制命令。
5. 身份验证，验证 auth
6. 发送从节点信息，用于主服务器的信息展示

### 数据同步阶段

在此阶段及以后，主服务器也会变成从服务器的一个客户端。原因是因为主服务器需要主动向从服务器发送数据。

从服务器向主服务器发送 psync 命令。主服务器判断当前状态，决定执行全量复制或者是部分复制。

主服务器判断全量复制或者部分复制过程：

1. 从服务器先按自身状态判断，如果是第一次复制，则向主服务器发送 psync ? -1 命令
2. 从服务器之前执行过 slaveof，发送 `psync <runid> <offset>`命令。`<runid>` 为主服务器的运行 id `<offset>` 从服务器保存的上次复制的偏移量
3. 主服务器收到 psync ? -1 进行全量复制
4. 如果主服务器 runid 与收到的 runid 相同，且 offset 存在于复制积压缓冲区中，则发送 +continue，并且发送从节点缺少的数据

如果主服务器 runid 与收到的 runid 不同，或 offset 已经被冲出复制积压缓冲区了，回复 +FULLRESYNC runid offset，表示需要进行全量复制，从节点记录 runid offset 以便后续使用。

#### 复制偏移量（offset）：

主节点与从节点都会维护一个 offset，代表主节点向从节点发送的字节数。主节点发送 n 个字节给从节点，主节点 offset+n。从节点接收到 n 个字节，从节点 offset+n。

#### 复制积压缓冲区（与复制缓冲区不同）：

主节点维护一个固定长度的 fifo 队列，记录主节点向从节点发送的命令。

1. 如果，从节点的 offset 之后的数据在复制积压缓冲区内，主服务器可以执行部分复制。
2. 否则，主节点不能区分出哪些命令需要发送给从节点，于是只能执行全量复制。

#### 运行 id（runid）：

每个服务器节点（无论主从），在启动时都会随机生成一个 runid。runid 用来唯一识别一个 redis 节点。
主从初次复制时，主服务器将自己的 runid 发送给从服务器。

## 全量复制

1. 主节点决定全量复制之后，执行 bgsave，fork 子进程生成 rdb 文件。并且生成一个缓冲区（复制缓冲区）记录之后生成执行的所有更新命令。
2. 将 rdb 文件发送给从节点，从节点清除老数据，然后载入 rdb，恢复数据到主服务器执行 bgsave 的时间。
3. 主服务器将复制缓冲区内的命令发送给从节点，从节点恢复数据到最新状态。
4. 如果从节点开启 aof，触发 bgwriteaof，生成最新的 aof。

## 部分复制

主服务器判断可以进行部分复制时，会根据从节点发送的 offset，从复制积压缓存区中找到数据发送给从节点。

## 命令传播（心跳机制）

1. 主服务器发送一个 ping 给 salve 服务器，让从节点做超时判断
2. 从服务器每秒发送一个 `replconf ack` 命令给主服务器，`replconf ask <offset>` 将从服务器保存的复制偏移量发送给主服务器。
3. 主节点收到心跳中发送的 offset 会与自身的 offset 进行比较，从复制积压缓冲区将缺少的命令发送给从节点。

## 遇到的问题及解决

### 读写分离问题

- **由于延迟导致的数据不一致问题**：同机房部署、监控主从节点的 offset，如果相差过大则通知应用不再从这个节点获取数据。
- **数据过期问题**：主从情况下，从节点不会主动删除过期数据，使用惰性删除，如果查询到过期数据就不返回。
- **宕机问题**：监控主从节点健康状态，使用哨兵自动切换主从。

### 复制超时问题

判断超时的意义：

- 主节点可以及时释放无效的从节点，释放资源。
- 从节点可以及时的与主节点进行重连，避免数据不一致。

#### 判断机制：

1. 主节点每秒执行一次定时任务，判断当前时间与上次收到各个节点的 replconf ack 时间是否超时，如果超时及时断开连接。
2. 从节点，每秒执行复制定时函数：
3. 建立连接阶段，距离上次收到主节点信息时间已经超时，释放连接。
   同步节点，收到 rdb 文件超时，释放连接。
4. 命令传播阶段，距离上次收到主节点的 ping 时间已经超时，释放连接。
